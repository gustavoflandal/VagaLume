version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: vagalume-db
    restart: always
    environment:
      MYSQL_DATABASE: vagalume
      MYSQL_USER: vagalume
      MYSQL_PASSWORD: vagalume123
      MYSQL_ROOT_PASSWORD: rootpass
      TZ: America/Sao_Paulo
    ports:
      - "3307:3306"
    volumes:
      - vagalumenew_db_data:/var/lib/mysql
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "vagalume", "-pvagalume123"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vagalume-backend
    restart: on-failure
    env_file:
      - ./backend/.env.docker
    environment:
      DATABASE_URL: mysql://vagalume:vagalume123@db:3306/vagalume  # Porta interna do container
      PORT: 3001
      NODE_ENV: production
      CORS_ORIGIN: "*"  # Permite acesso de qualquer origem
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "0.0.0.0:3001:3001"  # Expõe em todas as interfaces de rede

  frontend:
    build:
      context: ./frontend-vue
      dockerfile: Dockerfile
    container_name: vagalume-frontend
    restart: always
    environment:
      # URL acessível do navegador (não do container)
      VITE_API_URL: http://192.168.1.21:3001/api
    depends_on:
      - backend
    ports:
      - "0.0.0.0:8080:80"  # Expõe na porta 8080 em todas as interfaces de rede

volumes:
  vagalumenew_db_data: