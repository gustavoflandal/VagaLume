services:
  # MySQL 8.0 Database
  mysql:
    image: mysql:8.0.35-debian
    container_name: vagalume_mysql
    restart: unless-stopped
    environment:
      # Configurações do banco
      MYSQL_ROOT_PASSWORD: VagaLume@Root2025!
      MYSQL_DATABASE: vagalume
      MYSQL_USER: vagalume
      MYSQL_PASSWORD: VagaLume@User2025!
      
      # Configurações de charset
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
      
      # Timezone Brasil
      TZ: America/Sao_Paulo
      
    ports:
      - "3306:3306"
    
    volumes:
      # Dados persistentes
      - mysql_data:/var/lib/mysql
      
      # Configurações customizadas
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/custom.cnf:ro
      
      # Script de inicialização
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
      
      # Scripts de seed (opcional)
      - ./docker/mysql/seed.sql:/docker-entrypoint-initdb.d/02-seed.sql:ro
      
      # Logs
      - mysql_logs:/var/log/mysql
      
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-time-zone=-03:00
      --sql-mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
      --innodb-buffer-pool-size=512M
      --innodb-log-file-size=128M
      --innodb-flush-method=O_DIRECT
      --innodb-flush-log-at-trx-commit=1
      --max-connections=200
      --wait-timeout=300
      --interactive-timeout=300
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
      --log-error=/var/log/mysql/error.log
      --general-log=0
      --div-precision-increment=4
      --local-infile=0
      
    networks:
      - vagalume_network
      
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "vagalume", "-pVagaLume@User2025!"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # phpMyAdmin (opcional - para administração visual)
  phpmyadmin:
    image: phpmyadmin/phpmyadmin:5.2
    container_name: vagalume_phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: vagalume
      PMA_PASSWORD: VagaLume@User2025!
      MYSQL_ROOT_PASSWORD: VagaLume@Root2025!
      PMA_ABSOLUTE_URI: http://localhost:8080/
    ports:
      - "8080:80"
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - vagalume_network

  # MySQL Backup (opcional - backup automático)
  mysql_backup:
    image: fradelg/mysql-cron-backup:latest
    container_name: vagalume_backup
    restart: unless-stopped
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: vagalume
      MYSQL_PASS: VagaLume@User2025!
      MYSQL_DB: vagalume
      CRON_TIME: "0 2 * * *"  # Backup diário às 2h
      MAX_BACKUPS: 7          # Manter 7 backups
      INIT_BACKUP: 0          # Não fazer backup inicial
      INIT_RESTORE_LATEST: 0  # Não restaurar na inicialização
    volumes:
      - mysql_backups:/backup
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - vagalume_network

volumes:
  # Volume persistente para dados do MySQL
  mysql_data:
    driver: local
    
  # Volume para logs do MySQL
  mysql_logs:
    driver: local
    
  # Volume para backups
  mysql_backups:
    driver: local

networks:
  vagalume_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16